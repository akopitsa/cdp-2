{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "AWS CloudFormation Template for Installing PuppetServer and PuppetAgent with NTP-server which deployed via Puppet",

  "Resources" : {
    "PuppetServerInstance" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "ImageId" : "ami-ae7bfdb8",
        "KeyName" : "id_rsa",
        "InstanceType" : "t2.micro",
        "AvailabilityZone" : "us-east-1a",
        "SecurityGroups" : [ {"Ref" : "PuppetSecurityGroup"} ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "puppet-server"
          }
        ],
        "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
                "#!/bin/bash \n",
                "rpm -ivh https://yum.puppetlabs.com/puppetlabs-release-pc1-el-7.noarch.rpm \n",
                "yum update \n",
                "yum -y install puppetserver ntpdate mc \n",
                "timedatectl set-timezone Europe/Kiev \n",
                "ntpdate 0.ua.pool.ntp.org \n",
                "echo 'dns_alt_names = #{$hostnamepuppetserver},server' >> /etc/puppetlabs/puppet/puppet.conf\n",
                "echo 'autosign = true' >>  /etc/puppetlabs/puppet/puppet.conf\n",
                "echo '[main]' >> /etc/puppetlabs/puppet/puppet.conf\n",
                "echo 'environment = production' >> /etc/puppetlabs/puppet/puppet.conf\n",
                "echo 'runinterval = 2m' >> /etc/puppetlabs/puppet/puppet.conf\n",
                "echo 'certname = \"", {"Fn::GetAtt" : [ "PuppetAgentInstance", "PublicDnsName" ]}, "\"' >> /etc/puppetlabs/puppet/puppet.conf\n",
                "echo 'server = \"", {"Fn::GetAtt" : [ "PuppetAgentInstance", "PublicDnsName" ]}, "\"'  >> /etc/puppetlabs/puppet/puppet.conf\n"
              ]
            ]
          }
        }
     }
   },

   "PuppetAgentInstance" : {
     "Type" : "AWS::EC2::Instance",
     "Properties" : {
       "ImageId" : "ami-ae7bfdb8",
       "KeyName" : "id_rsa",
       "InstanceType" : "t2.micro",
       "AvailabilityZone" : "us-east-1a",
       "SecurityGroups" : [ {"Ref" : "PuppetSecurityGroup"} ],
       "Tags": [
         {
           "Key": "Name",
           "Value": "puppet-agent"
         }
       ]
    }
  },

   "PuppetSecurityGroup" : {
     "Type" : "AWS::EC2::SecurityGroup",
     "Properties" : {
       "GroupDescription" : "Enable HTTP access via port 80",
       "SecurityGroupIngress" : [
         {"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0"}
       ]
     }
   }
 },
  "Outputs" : {
    "PuppetAgentInstanceId" : {
      "Description" : "Puppet Agent Instance of the newly created EC2 instance",
      "Value" : { "Ref" : "PuppetAgentInstance" }
    },
    "PuppetAgentInstanceId" : {
      "Description" : "Puppet Agent Instance of the newly created EC2 instance",
      "Value" : { "Ref" : "PuppetServerInstance" }
    },
    "PuppetAgentPublicDNS" : {
      "Description" : "Public DNSName of the newly created Puppet Agent instance",
      "Value" : { "Fn::GetAtt" : [ "PuppetAgentInstance", "PublicDnsName" ] }
    },
    "PuppetAgentPublicIP" : {
      "Description" : "Public IP address of the newly created Puppet Agent instance",
      "Value" : { "Fn::GetAtt" : [ "PuppetAgentInstance", "PublicIp" ] }
    },
    "PuppetServerInstanceId" : {
      "Description" : "Puppet Agent Instance of the newly created Puppet Server instance",
      "Value" : { "Ref" : "PuppetServerInstance" }
    },
    "PuppetServerInstanceId" : {
      "Description" : "Puppet Agent Instance of the newly created Puppet Server instance",
      "Value" : { "Ref" : "PuppetServerInstance" }
    },
    "PuppetServerPublicDNS" : {
      "Description" : "Public DNSName of the newly created Puppet Server instance",
      "Value" : { "Fn::GetAtt" : [ "PuppetServerInstance", "PublicDnsName" ] }
    },
    "PuppetServerPublicIP" : {
      "Description" : "Public IP address of the newly created Puppet Server instance",
      "Value" : { "Fn::GetAtt" : [ "PuppetServerInstance", "PublicIp" ] }
    }
  }
}
